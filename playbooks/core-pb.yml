- hosts: vms
  gather_facts: true
  user: vagrant
  become: true
  tasks:
    - name: update cache
      ansible.builtin.apt:
        update_cache: yes
      tags:
        - update_cache
    - name: install git
      ansible.builtin.apt:
        name: git
        state: present
      tags:
        - git
        - install
    - name: install make
      ansible.builtin.apt:
        name: make
        state: present
      tags:
        - make
        - install
    - name: load node gpg key
      ansible.builtin.apt_key:
        url: https://deb.nodesource.com/gpgkey/nodesource.gpg.key
        keyring: /etc/apt/trusted.gpg.d/nodesource.gpg
        state: present
      tags:
        - nodejs
        - install
    - name: load node repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/etc/apt/trusted.gpg.d/nodesource.gpg] https://deb.nodesource.com/node_18.x {{ ansible_distribution_release }} main"
        state: present
      tags:
        - nodejs
        - install
    - name: install nodejs
      ansible.builtin.apt:
        name: nodejs
        state: present
        update_cache: yes
      tags:
        - nodejs
        - install
    - name: remove git
      ansible.builtin.apt:
        name: git
        state: absent
      tags:
        - git
        - remove
    - name: remove make
      ansible.builtin.apt:
        name: make
        state: absent
      tags:
        - make
        - remove
    - name: remove nodejs
      ansible.builtin.apt:
        name: nodejs
        state: absent
      tags:
        - nodejs
        - remove
    - name: remove node gpg key
      ansible.builtin.apt_key:
        url: https://deb.nodesource.com/gpgkey/nodesource.gpg.key
        keyring: /etc/apt/trusted.gpg.d/nodesource.gpg
        state: absent
      tags:
        - nodejs
        - remove
    - name: remove node repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/etc/apt/trusted.gpg.d/nodesource.gpg] https://deb.nodesource.com/node_18.x {{ ansible_distribution_release }} main"
        state: absent
      tags:
        - nodejs
        - remove
    - name: add users
      ansible.builtin.user:
        name: "{{ item }}"
        create_home: yes
        shell: /bin/bash
        comment: "User {{ item }} created by Ansible"
        password: "{{ item | password_hash('sha512') }}"
        state: present
      loop:
        - arya
        - sansa
        - tirion
      tags:
        - users
        - add
    - name: remove users
      ansible.builtin.user:
        name: "{{ item }}"
        state: absent
        remove: true
      loop:
        - arya
        - sansa
        - tirion
      tags:
        - users
        - remove